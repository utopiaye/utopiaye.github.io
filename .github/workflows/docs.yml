name: æ„å»ºå¹¶éƒ¨ç½² VuePress æ–‡æ¡£
on:
  push:
    branches: [main]
    # åªåœ¨æ–‡æ¡£ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶è§¦å‘ï¼Œæå‡æ•ˆç‡
    paths:
      - "docs/**"
      - ".vuepress/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/docs.yml"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ç¡®ä¿æ£€å‡ºå®Œæ•´å†å²ï¼Œç”¨äºæœ€åæ›´æ–°æ—¶é—´ç­‰åŠŸèƒ½
          fetch-tags: true

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0 # æ˜ç¡®æŒ‡å®š pnpm ç‰ˆæœ¬ï¼Œè§£å†³ç‰ˆæœ¬é—®é¢˜
          run_install: false # ç¨åæ‰‹åŠ¨å®‰è£…ï¼Œæ›´çµæ´»

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"
          # ç¼“å­˜ key åŒ…å« lockfile å†…å®¹å“ˆå¸Œï¼Œç¡®ä¿ä¾èµ–å˜æ›´æ—¶é‡æ–°ç¼“å­˜
          cache-dependency-path: pnpm-lock.yaml

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "å½“å‰ pnpm ç‰ˆæœ¬: $(pnpm --version)"
          pnpm install --frozen-lockfile
        # å¤±è´¥æ—¶é‡è¯•ä¸€æ¬¡
        continue-on-error: false
        retries: 1

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          # è¿è¡Œ lint æ£€æŸ¥ï¼Œç¡®ä¿ä»£ç è´¨é‡
          if pnpm run --if-present lint; then
            echo "ä»£ç æ£€æŸ¥é€šè¿‡"
          else
            echo "ä»£ç æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤"
            exit 1
          fi

      - name: æ„å»º VuePress ç«™ç‚¹
        run: |
          echo "å¼€å§‹æ„å»ºæ–‡æ¡£ç«™ç‚¹..."
          pnpm docs:build
          echo "æ„å»ºå®Œæˆï¼Œè¾“å‡ºç›®å½•å¤§å°:"
          du -sh docs/.vuepress/dist  # æ˜¾ç¤ºæ„å»ºç›®å½•å¤§å°

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "æ„å»ºäº§ç‰©å†…å®¹:"
          ls -la docs/.vuepress/dist
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "docs/.vuepress/dist/index.html" ]; then
            echo "é”™è¯¯: æ„å»ºäº§ç‰©ä¸å®Œæ•´ï¼Œæœªæ‰¾åˆ° index.html"
            exit 1
          fi

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: gh-pages
          build_dir: docs/.vuepress/dist
          # é…ç½®ç¼“å­˜æ§åˆ¶ï¼Œä¼˜åŒ–è®¿é—®é€Ÿåº¦
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: éƒ¨ç½²ç»“æœé€šçŸ¥
        if: success() || failure()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ æ–‡æ¡£éƒ¨ç½²æˆåŠŸ! è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"
          else
            echo "âŒ æ–‡æ¡£éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æ’æŸ¥é—®é¢˜"
            exit 1
          fi
